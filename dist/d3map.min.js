/*! d3map VERSION: 0.1.0 10-10-2014 */
var d3map=d3map||{};!function(){"use strict";d3map.map=function(a,b){function c(){var a=k.scale(q.scale()).translate(q.translate())();h.tiles=a,l.scale(q.scale()/2/Math.PI).translate(q.translate()),u.attr("transform","translate("+q.translate()+")scale("+q.scale()+")").style("stroke-width",1/q.scale()),s.attr("transform","scale("+a.scale+")translate("+a.translate+")"),h.layers().forEach(function(a){a.refresh()})}function d(a){this.tile.size(a)}function e(){return this._layers}function f(a){return a.id()?(this._layers.forEach(function(b){return b.id()==a.id()?(a=b,!0):void 0}),this._layers.push(a),!0):(console.warn("Not a valid layer. (No ID)"),!1)}function g(a){return this._layers.forEach(function(b,c){return b.id()==a?(this._layers.splice(c,1),!0):void 0}),!1}var h=this;this._layers=[];var i=Math.max(960,window.innerWidth),j=Math.max(500,window.innerHeight);this.divid=a;var k=d3.geo.tile().size([i,j]);this.tile=k;var l=d3.geo.mercator().scale((b.zoom<<12||4096)/2/Math.PI).translate([i/2,j/2]);this.projection=l;var m=d3.geo.mercator().scale(.5/Math.PI).translate([0,0]);this.projection2=m;var n=l(b.center||[0,0]);this.center=n;var o=d3.geo.path().projection(l);this.path=o;var p=d3.geo.path().projection(m);this.path_transform=p,this.draw=c;var q=d3.behavior.zoom().scale(2*l.scale()*Math.PI).scaleExtent([256,1<<24]).translate([i-n[0],j-n[1]]).on("zoom",c);this.zoom=q;var r=d3.select("#"+a).append("svg").attr("width",i).attr("height",j);this.svg=r;var s=r.append("g").attr("id","raster");this.raster=s;var t=r.append("g").attr("id","vector");this.vector=t;var u=r.append("g").attr("id","vector_transform");this.vector_transform=u;d3.select("#"+a).append("canvas").attr("width",i).attr("height",j);return r.call(q),this.resize=d,this.layers=e,this.addLayer=f,this.removeLayer=g,this}}();var d3map=d3map||{};!function(){"use strict";d3map.Layer=function(a,b){this._id=a,this._map=b},d3map.Layer.prototype={id:function(){return this._id},setOpacity:function(a){this._opacity=a,this.draw()},setVisibility:function(a){this._isvisible=a,this.draw(),this.refresh()}}}();var d3map=d3map||{};!function(){"use strict";d3map.Rasterlayer=function(a,b,c){d3map.Layer.call(this,a,b),this._id=a,this._type=c.type,this._url=c.url,this._layers=c.layers,this._map=b,this._opacity=1,this._isvisible=!0},d3map.Rasterlayer.prototype=Object.create(d3map.Layer.prototype),d3map.Rasterlayer.prototype.clear=function(){this._map.raster.selectAll("."+this._id).remove()},d3map.Rasterlayer.prototype.draw=function(){var a=this,b=this._map.tiles,c=this._map.raster,d=c.selectAll("."+this._id).data(b,function(a){return a}),e=d.enter();this._isvisible?e.append("image").classed(this._id,!0).attr("xlink:href",function(b){var c="";if("tms"==a._type)c=a._url.replace("{s}",["a","b","c","d"][4*Math.random()|0]).replace("{z}",b[2]).replace("{x}",b[0]).replace("{y}",b[1]);else if("wms"==a._type){var d=2<<b[2]-1,e=40075016.68/d,f=-20037508.34+b[0]*e,g=20037508.34-(b[1]+1)*e,h=f+", "+g+","+(f+e)+","+(g+e);c=a._url+"&bbox="+h+"&layers="+a._layers+"&service=WMS&version=1.1.0&request=GetMap&tiled=true&styles=&width=256&height=256&srs=EPSG:900913&transparent=TRUE&format=image%2Fpng"}return c}).attr("width",1).attr("height",1).attr("opacity",a._opacity).attr("x",function(a){return a[0]}).attr("y",function(a){return a[1]}):d.remove(),d.exit().remove()},d3map.Rasterlayer.prototype.refresh=function(){var a=this._map.raster,b=a.selectAll("."+this._id);b.style("opacity",this._opacity),this.draw()}}();var d3map=d3map||{};!function(){"use strict";d3map.Vectorlayer=function(a,b){d3map.Layer.call(this,a,b)},d3map.Vectorlayer.prototype=Object.create(d3map.Layer.prototype),d3map.Vectorlayer.prototype.draw=function(){},d3map.Vectorlayer.prototype.refresh=function(){},d3map.Vectorlayer.prototype.data=function(){}}();var d3map=d3map||{};!function(){"use strict";d3map.vectorlayer2=function(a,b,c){_.extend(this,d3map.layer),this._data=c.data,this._id=a,this._map=b,this._r=c.r,this._type=c.type||"path",this._maxzoom=c.maxzoom,this._minzoom=c.minzoom,this._labels=c.labels||!1,this._labelconfig=c.labelconfig,this._style=c.style||{},this._g=this._map.vector_transform.append("g").attr("id",this._id),this._onmouseover=c.onmouseover,this._onclick=c.onclick,this._mouseoverContent=c.mouseoverContent,this._opacity=c.opacity||1,this._isvisible=c.visible||!0},d3map.vectorlayer2.prototype.clear=function(){this._map.vector_transform.select("#"+this._id).selectAll(".entity").remove()},d3map.vectorlayer2.prototype.redraw=function(){var a=this._map.projection;this.projection=a;var b=(this._map.pointprojection,this._map.clicked,this._map.path_transform),c=this,d=this._style,e=this._labels,f=this._labelconfig,g=d3.select("#"+c._map.divid).append("div").attr("id","tooltipdiv").style("position","absolute"),h=function(a){a.origopac||(a.origopac=d3.select(this).style("opacity")),d3.select(this).transition().duration(100).style("opacity",.2*a.origopac);var b="";_(a.properties).each(function(a,c){b=b+"<b>"+c+"</b>"+a+"<br>"}),g.transition().duration(200).style("opacity",.9),g.html(b+"<br/>").style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px")},i=function(a){d3.select(this).transition().duration(100).style("opacity",a.origopac),g.transition().duration(500).style("opacity",0),g.transition().delay(1500).style("top","-100px")},j=function(){},k=function(b){var c=d3.select(this);if(b.style&&b.style["marker-url"]&&"Point"==b.geometry.type){a(b.geometry.coordinates)[0],a(b.geometry.coordinates)[1],c.append("image").on("click",j).on("mouseover",h).on("mouseout",i)}else{c.append("path").attr("d",n(b)).on("click",j).on("mouseover",h).on("mouseout",i)}},l=function(b){var c=d3.select(this);if(b.style&&b.style["marker-url"]&&"Point"==b.geometry.type){a(b.geometry.coordinates)[0],a(b.geometry.coordinates)[1],c.select("image").attr("xlink:href",function(a){return a.style["marker-url"]}).classed("nodeimg",!0).attr("width",32).attr("height",37).style("opacity",function(a){return a.style.opacity||d.opacity||1})}else{var e=c.select("path");_(d).each(function(a,b){"stroke-width"!=b&&e.style(b,function(a){if("function"==typeof d[b]){var c=d[b];return c(a)}return d[b]})}),_(b.style).each(function(a,b){e.style(b,a)})}},m=function(a){var b=this;_(f.style).each(function(a,c){d3.select(b).style(c,function(a){return a.labelconfig&&a.labelconfig.style&&a.labelconfig.style[c]?a.labelconfig.style[c]:f.style[c]})}),a.labelconfig&&a.labelconfig.style&&_(a.labelconfig.style).each(function(c,d){d3.select(b).style(d,a.labelconfig.style[d])})},n=function(a){return a.style&&a.style.radius?b.pointRadius(a.style.radius):d&&d.radius&&b.pointRadius(d.radius),b(a)};this.pathStyler=n;var o=function(a){var c=b.centroid(a),e=b.bounds(a);if(d&&d.textlocation)switch(d.textlocation){case"ul":c[0]=e[0][0],c[1]=e[0][1];break;case"ur":c[0]=e[1][0],c[1]=e[1][1]}else c[1]=c[1]+20;return c};this.textLocation=o;var p=function(a){if(f.field&&a.properties){var b=a.properties[f.field];return b&&b.length>10?b.substr(0,16)+"...":b}return a.id};this.labelgenerator=p;var q=this._map.vector_transform.select("#"+this._id).selectAll(".entity").data(this._data,function(a){return a.id});if(this._isvisible){var r=q.enter().append("g").classed("entity",!0).attr("id",function(a){return"entity"+a.id});if(r.each(k),e){var s=r.append("g").classed("place-label",!0);s.append("text").attr("x",function(a){return o(a)[0]}).attr("y",function(a){return o(a)[1]}).attr("text-anchor","left").style("stroke","white").style("stroke-width","3px").style("stroke-opacity",.8).text(function(a){return p(a)}),s.append("text").attr("x",function(a){return o(a)[0]}).attr("y",function(a){return o(a)[1]}).attr("text-anchor","left").each(m).text(function(a){return p(a)})}}else q.remove();q.each(l),q.exit().remove().transition().duration(500),this.refresh()},d3map.vectorlayer2.prototype.refresh=function(){this._map.vector_transform.select("#"+this._id).selectAll(".entity"),this._map.path_transform,this._map.zoom,this.textLocation,this._labels,this.pathStyler},d3map.vectorlayer2.prototype.data=function(a){this._map.projection,this._map.pointprojection,this._map.clicked,this._style;this._data=a,this.redraw()}}();var d3map=d3map||{};!function(){"use strict";d3map.canvaslayer=function(a,b,c){_.extend(this,d3map.layer),this._data=c.data,this._id=a,this._map=b,this._r=c.r,this._type=c.type||"path",this._maxzoom=c.maxzoom,this._minzoom=c.minzoom,this._labels=c.labels||!1,this._labelconfig=c.labelconfig,this._style=c.style||{},this._g=this._map.vector.append("g").attr("id",this._id),this._onmouseover=c.onmouseover,this._onclick=c.onclick,this._mouseoverContent=c.mouseoverContent,this._opacity=c.opacity||1,this._isvisible=c.visible||!0},d3map.canvaslayer.prototype.clear=function(){},d3map.canvaslayer.prototype.redraw=function(){{var a=this._map.canvas;a.node().getContext("2d")}},d3map.canvaslayer.prototype.refresh=function(){},d3map.canvaslayer.prototype.data=function(a){this._map.projection,this._map.pointprojection,this._map.clicked,this._style;this._data=a,this.redraw()}}();var Cop=window.Cop||{};Cop_utils={},Cop_utils.menuconfig={name:"root",children:[{name:"model.populator",icon:"./css/img/users_icon.png",label:"Populatie",size:1},{name:"edit.geom",icon:"./css/img/pencil_icon.png",label:"Bewerken",value:1},{name:"delete",icon:"./css/img/clipboard_cut_icon.png",label:"Verwijderen",value:1},{name:"edit.text",icon:"./css/img/text_letter_t_icon.png",label:"Tekst",size:1}]},Cop_utils.menu=function(a,b,c,d,e){var f=this,g=a.id;d3.selectAll(".popup").remove();var h,i,j=a,k=e.menuconfig;this._svg=i=c,h=i.append("g");{var l=d3.mouse(d);({x:b.layerX,y:b.layerY})}navigator.userAgent.match("Firefox")&&(l[0]=l[0]+10,l[1]=l[1]+10),navigator.userAgent.match("MSIE")&&(l[0]=l[0]-140,l[1]=l[1]+2),h.attr("class","popup").attr("transform",function(){var a=l[0],b=l[1];return"translate("+a+","+b+")"});var m=k;width=150,height=150;var n=Math.min(width,height)/2,o=d3.layout.partition().sort(null).size([2*Math.PI,n*n]).value(function(a){return a.value||1}),p=d3.svg.arc().startAngle(function(a){return a.x}).endAngle(function(a){return a.x+a.dx}).innerRadius(function(a){return Math.sqrt(.7*a.y)}).outerRadius(function(a){return Math.sqrt(1.5*(a.y+a.dy))}),q=d3.scale.category10(),r=h.append("g");if("true"==r.attr("selected"))r.select(".popup").remove(),r.attr("selected","false");else{r.attr("selected","true");var s=r.append("g").classed("pie popup",!0).attr("width",width).attr("height",height).append("g").attr("class","zoomable"),h=s.datum(m).selectAll("arc1").data(o.nodes).enter().append("g").attr("class","arc1").on("click",function(a){r.remove(),d3.event.stopPropagation();var b=a.name;f.trigger(b,{fid:g,layer:j,obj:d})}).on("mouseover",function(){d3.select(this).append("text").classed("menu_shadow",!0).attr("dy",0).attr("dx",0).text(function(a){return a.label}),d3.select(this).append("text").classed("menu",!0).attr("dy",0).attr("dx",0).text(function(a){return a.label})}).on("mouseout",function(){d3.select(this).style("opacity",1).selectAll("text").remove()});h.append("path").style("opacity",0).transition().style("opacity",1).attr("d",function(a){return p(a)}).style("stroke","#fff").style("fill",function(a){return"root"==a.name?"none":a.parent&&"P"==a.parent.name?"none":q(a.parent&&"root"==a.parent.name?a.name:a.name)}),h.append("svg:image").attr("transform",function(a){return"translate("+p.centroid(a)+")"}).attr("x",-9).attr("y",-12).attr("width",20).attr("height",24).attr("xlink:href",function(a){return a.icon})}},Cop_utils.populator=function(){},Cop_utils.editText=function(){},Cop_utils.textbox=function(a,b){var c=this.map;d3.select(b).on("mouseout",function(){d3.selectAll(".textbox").remove()});var d=(d3.mouse(b),[d3.event.screenX,d3.event.screenY]),e=c.core.project().items(a.properties.key),f=(a.properties.name||"",a.properties.desc||""),g=a.properties.owner||"Anoniem",h="";if(e.permissions("edit")){var i=e.permissions("edit").groups;$.each(i,function(a,b){var d=c.core.project().groups(b).data("name");"public"!=d&&(h+=d)})}var j=c.core.project().groups(),k=[];$.each(j,function(a,b){k.push(b._id)});var l=d3.select("body").append("div").style("left",d[0]+25+"px").style("top",d[1]+-100+"px").classed("textbox popup share ui-draggable",!0),m=l.append("div").classed("sheader",!0).attr("title","Dit object is gemaakt door");m.append("span").classed("group "+h,!0),m.append("span").html(h+" <small>("+g+")</small>");var n=l.append("div").classed("scontent",!0);if(f=f.replace(/\r\n?|\n/g,"<br />"),n.append("div").classed("ssubheader",!0).html(f),sfooter=l.append("div").classed("sfooter",!0).attr("id","permissionlist").html("Gedeeld met:"),e.permissions("view")){var o=e.permissions("view").groups,p=d3.select("#permissionlist").selectAll(".permission").data(o);p.enter().append("span").attr("class",function(a){var b=c.core.project().groups(a).data("name");return"group "+b})}},Cop_utils.ripple=function(a,b,c){console.log(c._map);var d=c._map,e=d.getSize().x,f=d.getSize().y,g=d3.mouse(b),h=d3.select(".leaflet-popup-pane").append("svg");h.attr("class","popup"),h.attr("width",e),h.attr("height",f);h.append("circle").attr("r",10).attr("cx",g[0]).attr("cy",g[1]).style("fill","none").style("stroke","green").transition().duration(2e3).attr("r",500).transition().duration(500).style("opacity",0).remove().call(function(){d3.selectAll(".popup").transition().duration(1e3).remove()})};